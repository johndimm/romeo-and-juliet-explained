(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{5557:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return n(4610)}])},9008:function(e,t,n){e.exports=n(7828)},8022:function(e,t,n){"use strict";function l(e){let t="https://romeo-and-juliet-explained.vercel.app",n=e.startsWith("/")?e:"/".concat(e);if(!t)return n;let l=t.endsWith("/")?t.slice(0,-1):t;return"".concat(l).concat(n)}n.d(t,{k:function(){return l}})},4610:function(e,t,n){"use strict";n.r(t),n.d(t,{__N_SSG:function(){return p},default:function(){return m}});var l=n(5893),o=n(9008),r=n(7294);n(3935);var i=n(8022);let a=(e,t,n)=>Math.min(n,Math.max(t,e)),s=e=>a(100-e,0,100),c=e=>a(100-e,0,100),u=e=>a(e,.7,1.6),d=e=>{"undefined"!=typeof document&&document.documentElement.style.setProperty("--font-scale",e.toFixed(3))},f={deepseek:"DeepSeek",openai:"OpenAI",anthropic:"Anthropic",gemini:"Gemini"},h=e=>{if(!e)return"";let t=e.toLowerCase();return f[t]?f[t]:e.charAt(0).toUpperCase()+e.slice(1)};var p=!0;function m(e){let{sections:t,sectionsWithOffsets:n,metadata:f,markers:h,precomputed:p}=e,[m,g]=(0,r.useState)(""),[b,S]=(0,r.useState)(""),[O,E]=(0,r.useState)(0),[j,k]=(0,r.useState)(0),T=(0,r.useRef)([]),[A,M]=(0,r.useState)(null),[C,I]=(0,r.useState)(null),[N,L]=(0,r.useState)({model:"gpt-4o-mini",language:"English",educationLevel:"High school",age:"16",provider:"openai",length:"brief"}),[R,F]=(0,r.useState)({}),[P,D]=(0,r.useState)(!1),[q,H]=(0,r.useState)(!1),[B,_]=(0,r.useState)(33),[W,J]=(0,r.useState)(1),Y=(0,r.useRef)(1),[K,U]=(0,r.useState)(!1),z=(0,r.useRef)(!1),X=(0,r.useRef)(null),[G,V]=(0,r.useState)([]),[$,Z]=(0,r.useState)(null);(0,r.useEffect)(()=>{try{let e=localStorage.getItem("forcedNotes");if(!e)return;let t=JSON.parse(e);if(!Array.isArray(t))return;let n=[];for(let e of t){let t=String(e||"");if(t.includes("|")){n.push(t);continue}let l=parseInt(t,10);if(Number.isFinite(l)&&f&&Array.isArray(f.speeches)){let e=null;for(let t of f.speeches)if((t.offset||0)<=l)e=t;else break;let t="Prologue",o="";if(Array.isArray(f.scenes)){for(let e of f.scenes)if(l>=e.startOffset&&l<=e.endOffset){t=e.act,o=e.scene;break}}if(e){let l=1;if(Array.isArray(f.speeches)){for(let n of f.speeches)if((()=>{if(!Array.isArray(f.scenes))return!1;for(let e of f.scenes)if(n.offset>=e.startOffset&&n.offset<=e.endOffset)return e.act===t&&e.scene===o;return"Prologue"===t})()){if(n.offset===e.offset)break;l++}}n.push("".concat(t,"|").concat(o,"|").concat(l))}}}n.length&&V(n)}catch(e){}},[f]),(0,r.useEffect)(()=>{try{localStorage.setItem("forcedNotes",JSON.stringify(G||[]))}catch(e){}},[G]);let Q=(0,r.useCallback)(function(e){let{commit:t=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=u(e);return d(n),Y.current=n,t&&J(e=>.001>Math.abs(e-n)?e:n),n},[J]);(0,r.useEffect)(()=>{let e=1;try{let t=window.localStorage.getItem("fontScale");if(null!==t&&""!==t){let n=parseFloat(t);Number.isFinite(n)&&(e=u(n))}}catch(e){}return Q(e,{commit:!0}),U(!0),()=>{}},[Q]),(0,r.useEffect)(()=>{if(Q(W),K){try{localStorage.setItem("fontScale",String(W))}catch(e){}window.dispatchEvent(new CustomEvent("font-scale-updated",{detail:{value:W}}))}},[Q,W,K]),(0,r.useEffect)(()=>{let e=e=>{var t;let n=null==e?void 0:null===(t=e.detail)||void 0===t?void 0:t.value,l="number"==typeof n?n:parseFloat(n);Number.isFinite(l)&&Q(l,{commit:!0})};return window.addEventListener("font-scale-set",e),()=>window.removeEventListener("font-scale-set",e)},[Q]),(0,r.useEffect)(()=>{if("undefined"==typeof document)return()=>{};let e={active:!1,startDist:0,startScale:1},t={startScale:1},n=null,l=null,o=e=>!e||e.length<2?0:Math.hypot(e[0].clientX-e[1].clientX,e[0].clientY-e[1].clientY),r=()=>{null!==l&&(cancelAnimationFrame(l),l=null),null!=n&&(Q(n),n=null)},i=e=>{n=e,null===l&&(l=requestAnimationFrame(()=>{l=null,null!=n&&(Q(n),n=null)}))},a=t=>{t.touches.length>=2?(r(),e.active=!0,e.startDist=o(t.touches),e.startScale=Y.current,window.__pinchActive=!0,t.preventDefault()):e.active=!1},s=t=>{if(!e.active||2!==t.touches.length)return;let n=o(t.touches);if(e.startDist<=0||n<=0)return;let l=n/e.startDist;i(e.startScale*l),t.preventDefault()},c=()=>!!e.active&&(r(),Q(Y.current,{commit:!0}),e.active=!1,window.__pinchActive=!1,!0),u=t=>{if(t.touches.length<2){let e=c();e||(window.__pinchActive=!1),e&&t.preventDefault();return}e.active&&t.preventDefault()},d=e=>{r(),t.startScale=Y.current,window.__pinchActive=!0,e.preventDefault()},f=e=>{let n="number"==typeof e.scale&&Number.isFinite(e.scale)?e.scale:1;i(t.startScale*n),e.preventDefault()},h=e=>{r(),Q(Y.current,{commit:!0}),window.__pinchActive=!1,e.preventDefault()},p=(e,t,n,l)=>{(null==e?void 0:e.addEventListener)&&e.addEventListener(t,n,l)},m=(e,t,n,l)=>{(null==e?void 0:e.removeEventListener)&&e.removeEventListener(t,n,l)},v={passive:!1},g=[window,document];return g.forEach(e=>{p(e,"touchstart",a,v),p(e,"touchmove",s,v),p(e,"touchend",u,v),p(e,"touchcancel",u,v),p(e,"gesturestart",d,v),p(e,"gesturechange",f,v),p(e,"gestureend",h,v)}),()=>{r(),g.forEach(e=>{m(e,"touchstart",a,v),m(e,"touchmove",s,v),m(e,"touchend",u,v),m(e,"touchcancel",u,v),m(e,"gesturestart",d,v),m(e,"gesturechange",f,v),m(e,"gestureend",h,v)}),window.__pinchActive=!1}},[Q]),(0,r.useEffect)(()=>{if("undefined"==typeof document)return()=>{};let e=null,t=null,n=null,l=()=>{null!==n&&(cancelAnimationFrame(n),n=null),null!=t&&(Q(t),t=null)},o=()=>{null===n&&(n=requestAnimationFrame(()=>{n=null,null!=t&&(Q(t),t=null)}))},r=()=>{e&&clearTimeout(e),e=setTimeout(()=>{l(),Q(Y.current,{commit:!0}),e=null},120)},i=e=>{if(window.__pinchActive||!e.ctrlKey)return;e.preventDefault();let n=Math.exp(-e.deltaY/500);t=u((null!=t?t:Y.current)*n),o(),r()},a=[window,document];return a.forEach(e=>{(null==e?void 0:e.addEventListener)&&e.addEventListener("wheel",i,{passive:!1})}),()=>{l(),e&&(clearTimeout(e),e=null),a.forEach(e=>{(null==e?void 0:e.removeEventListener)&&e.removeEventListener("wheel",i,{passive:!1})})}},[Q]);let ee=(e,t)=>{V(t=>{let n=Array.isArray(t)?t.slice():[],l=String(e),o=n.indexOf(l);return o>=0?n.splice(o,1):n.push(l),n});try{if(Array.isArray(n)){var l;let e=null==n?void 0:null===(l=n[t])||void 0===l?void 0:l.startOffset;"number"==typeof e&&localStorage.setItem("last-pos",String(e))}}catch(e){}};T.current=[],(0,r.useEffect)(()=>{k(T.current.length),E(0)},[m]),(0,r.useEffect)(()=>{if(j>0&&T.current[O]){T.current.forEach(e=>e&&e.classList.remove("current"));let e=T.current[O];e.classList.add("current");let t=ey();if(t)try{let n=Math.max(0,ex(e,t)-(t.clientHeight?(t.clientHeight-e.clientHeight)/2:80));t===window?window.scrollTo({top:n,behavior:"smooth"}):t.scrollTo({top:n,behavior:"smooth"})}catch(t){e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}else e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}else T.current.forEach(e=>e&&e.classList.remove("current"))},[O,j]);let et=()=>{0!==j&&E(e=>(e-1+j)%j)},en=()=>{0!==j&&E(e=>(e+1)%j)},el=(0,r.useMemo)(()=>{if(!(null==f?void 0:f.scenes))return[];let e=f.scenes.filter(e=>e.act&&e.scene),t=e=>{let t=0;for(let l=0;l<n.length&&n[l].startOffset<=e;l++)t=l;return t},l=new Map;for(let n of e){let e=t(n.startOffset),o={act:n.act,scene:n.scene,title:n.title||"SCENE ".concat(n.scene),startOffset:n.startOffset,sectionIndex:e};l.has(n.act)||l.set(n.act,[]),l.get(n.act).push(o)}let o=[];for(let[e,t]of l.entries())t.sort((e,t)=>e.startOffset-t.startOffset),o.push({act:e,scenes:t});let r=e=>{let t={I:1,V:5,X:10,L:50,C:100,D:500,M:1e3},n=0,l=0;for(let o=e.length-1;o>=0;o--){let r=t[e[o]]||0;r<l?n-=r:n+=r,l=r}return n};if(o.sort((e,t)=>r(e.act)-r(t.act)),(null==h?void 0:h.prologueStart)!=null){let e=(e=>{let t=0;for(let l=0;l<n.length&&n[l].startOffset<=e;l++)t=l;return t})(h.prologueStart);o.unshift({act:"Prologue",scenes:[{act:"Prologue",scene:"",title:"THE PROLOGUE",startOffset:h.prologueStart,sectionIndex:e}]})}return o},[f,n,h]),eo=(0,r.useMemo)(()=>{let e=f||{},t=Array.isArray(e.scenes)?e.scenes:[],l=Array.isArray(e.speeches)?e.speeches:[],o=new Map,r=[],i=e=>{for(let n of t)if(e>=n.startOffset&&e<=n.endOffset)return{act:n.act,scene:n.scene};let n=t.find(e=>"II"===e.act&&"I"===e.scene);return n&&e>=3e4&&e<n.startOffset?{act:"II",scene:""}:{act:"Prologue",scene:""}};for(let e of l){let{act:t,scene:n}=i(e.offset||0),l="".concat(t,"#").concat(n),a=o.get(l)||[],s=a.length+1,c={offset:e.offset||0,speaker:e.speaker||"",act:t,scene:n,speechIndex:s};a.push(c),o.set(l,a),r.push(c)}let a=new Map;for(let e of Array.isArray(p)?p:[]){let t=e.act||e.Act||"",n=null!=e.scene?String(e.scene):"",l="".concat(t,"#").concat(n),r=o.get(l)||[];if(!r.length)continue;let i=Number(e.startOffset||0),s=r[0];for(let e=0;e<r.length&&r[e].offset<=i;e++)s=r[e];let c="".concat(s.act,"|").concat(s.scene,"|").concat(s.speechIndex);a.has(c)||a.set(c,e)}let s=new TextEncoder,c=n.map(e=>{let t=e.startOffset||0,n=t+s.encode(e.text||"").length;return{start:t,end:n}}),u=new Map;for(let e=0;e<c.length;e++)u.set(e,[]);for(let e of r)for(let t=0;t<c.length;t++){let{start:n,end:l}=c[t];if(e.offset>=n&&e.offset<l){u.get(t).push(e);break}}return{noteBySpeechKey:a,speechesBySection:u}},[f,n,p]);(0,r.useMemo)(()=>{if(!Array.isArray(p)||!p.length)return new Map;let e=new TextEncoder,t=n.map(t=>{let n=t.startOffset||0,l=n+e.encode(t.text||"").length;return{start:n,end:l}}),l=new Map,o=(e,t,n,l)=>Math.max(e,n)<Math.min(t,l);for(let e of p){var r,i;let n=null!==(r=null==e?void 0:e.startOffset)&&void 0!==r?r:null,a=null!==(i=null==e?void 0:e.endOffset)&&void 0!==i?i:null;if(null!=n){if(null==a){let o=0;for(let e=0;e<t.length&&t[e].start<=n;e++)o=e;l.has(o)||l.set(o,[]),l.get(o).push(e);continue}for(let r=0;r<t.length;r++){let{start:i,end:s}=t[r];o(n,a,i,s)&&(l.has(r)||l.set(r,[]),l.get(r).push(e))}}}for(let[e,t]of l.entries())t.sort((e,t)=>(e.startOffset||0)-(t.startOffset||0));return l},[p,n]);let[er,ei]=(0,r.useState)(null),ea=(0,r.useRef)([]),[es,ec]=(0,r.useState)(null),[eu,ed]=(0,r.useState)(!1),[ef,eh]=(0,r.useState)(!1),ep=(0,r.useRef)(0),em=(0,r.useRef)(!1),ev=(0,r.useMemo)(()=>{try{let e=localStorage.getItem("last-scroll"),t=e?parseFloat(e):NaN;return{attempted:!Number.isNaN(t)&&t>50}}catch(e){return{attempted:!1}}},[]),eg=(0,r.useRef)(ev.attempted);function ey(){if("undefined"==typeof document)return null;let e=document.querySelector(".container");if(e&&e.scrollHeight>e.clientHeight+1)return e;let t=document.querySelector(".page");return t&&t.scrollHeight>t.clientHeight+1?t:window}function ex(e,t){let n=e.getBoundingClientRect();if(!t||t===window)return n.top+window.scrollY;let l=t.getBoundingClientRect();return n.top-l.top+t.scrollTop}(0,r.useEffect)(()=>{let e=ey(),t=null,l=!1,o=()=>{l||(l=!0,t=requestAnimationFrame(()=>{var e;l=!1;let t=ey();if(!t)return;let o=t===window?window.scrollY:t.scrollTop,r=ea.current.filter(Boolean),i=0;for(let e=0;e<r.length;e++){let n=r[e];if(n){if(ex(n,t)<=o+40)i=e;else break}}ed(o>240);let a=null===(e=n[i])||void 0===e?void 0:e.startOffset;if(null!=a&&(null==f?void 0:f.scenes)){let e=null;for(let t of f.scenes)if(null!=t.startOffset&&null!=t.endOffset&&a>=t.startOffset&&a<=t.endOffset){e={act:t.act,scene:t.scene};break}ei(e?"".concat(e.act,"-").concat(e.scene):null);try{e&&e.act&&localStorage.setItem("printAct",String(e.act||"")),e&&(e.scene||""===e.scene)&&localStorage.setItem("printScene",String(e.scene||""))}catch(e){}}try{if(eg.current){if(Date.now()-("undefined"!=typeof performance&&performance.timing?performance.timing.navigationStart:0)<3e3)return;eg.current=!1}let e=Date.now();if(e-(ep.current||0)>500){let n=t===window?document.documentElement.scrollHeight:t.scrollHeight;if(o>100){let e="window";if(t!==window){if(t.classList&&t.classList.contains("container"))e="container";else if(t.classList&&t.classList.contains("page"))e="page";else{let n=document.querySelector(".container")===t,l=document.querySelector(".page")===t;e=n?"container":l?"page":"unknown"}}localStorage.setItem("last-scroll",String(o)),localStorage.setItem("last-scrollHeight",String(n)),localStorage.setItem("last-scroll-container",e)}ep.current=e}}catch(e){}}))};return e&&(e.addEventListener("scroll",o,{passive:!0}),requestAnimationFrame(()=>o())),()=>{t&&cancelAnimationFrame(t);let e=ey();e&&e.removeEventListener("scroll",o)}},[f,n]),(0,r.useEffect)(()=>{try{if(em.current||!n||!n.length||/^#sel=/.test(window.location.hash||""))return;let e=NaN,t=NaN,l=null,o=localStorage.getItem("last-scroll");o&&(e=parseFloat(o));let r=localStorage.getItem("last-scrollHeight");r&&(t=parseFloat(r));let i=localStorage.getItem("last-scroll-container");if(i&&(l=i),!(!isNaN(e)&&e>50)){try{!isNaN(e)&&e<=50&&(localStorage.removeItem("last-scroll"),localStorage.removeItem("last-scrollHeight"),localStorage.removeItem("last-scroll-container"))}catch(e){}eg.current=!1;return}eg.current=!0;let a=0,s=e,c=t,u=l,d=()=>{a++;let e=ey();if(!e||!(ea.current&&ea.current.length>0&&ea.current[0])){a<20&&setTimeout(d,50);return}requestAnimationFrame(()=>{requestAnimationFrame(()=>{let t=e===window?document.documentElement.scrollHeight:e.scrollHeight,n=e===window?document.documentElement.clientHeight:e.clientHeight;if(t<=n){a<20&&setTimeout(d,50);return}let l="window";if(e!==window){if(e.classList&&e.classList.contains("container"))l="container";else if(e.classList&&e.classList.contains("page"))l="page";else{let t=document.querySelector(".container")===e,n=document.querySelector(".page")===e;l=t?"container":n?"page":"unknown"}}let o=u&&u!==l,r=window.innerWidth<=820,i=s,f=!isNaN(c)&&c>0&&t>0,h=s>1e3;if(f&&!(r&&o)&&((c>0?Math.abs(t-c)/c*100:0)>10&&h||o&&h&&!r)){let e=s/c;i=t*e}e===window?window.scrollTo({top:i,behavior:"auto"}):e.scrollTop=i,setTimeout(()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{let t=e===window?window.scrollY:e.scrollTop;Math.abs(t-i)>(r?300:100)&&s>1e3?(e===window?window.scrollTo({top:s,behavior:"auto"}):e.scrollTop=s,em.current=!0,setTimeout(()=>{eg.current=!1},50)):(em.current=!0,eg.current=!1)})})},r?200:150)})})},f=!1,h=()=>{f||(f=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{d()},150)})}))};setTimeout(()=>{h()},500)}catch(e){}},[n,f]);let ew=e=>{let t=ea.current[e];if(!t)return;let n=ey();if(!n)return;let l=ex(t,n)-8;n===window?window.scrollTo({top:Math.max(0,l),behavior:"smooth"}):n.scrollTo({top:Math.max(0,l),behavior:"smooth"})},eb=()=>{let e=ey();e&&(e===window?window.scrollTo({top:0,behavior:"smooth"}):e.scrollTo({top:0,behavior:"smooth"}))};(0,r.useEffect)(()=>{let e=()=>{window.innerWidth<=820?eh(!0):eb()};return window.addEventListener("toggle-toc",e),()=>{window.removeEventListener("toggle-toc",e)}},[]),(0,r.useEffect)(()=>{let e=e=>{"Escape"===e.key&&eh(!1)};return window.addEventListener("keydown",e),"undefined"!=typeof document&&(ef?document.body.style.overflow="hidden":document.body.style.overflow=""),()=>{window.removeEventListener("keydown",e)}},[ef]),(0,r.useEffect)(()=>{var e;if(!A||!f||!n||!t){I(null);return}let{sectionIndex:l,start:o}=A,r=t[l];if(!r){I(null);return}let i=new TextEncoder().encode(r.slice(0,o)).length,a=((null===(e=n[l])||void 0===e?void 0:e.startOffset)||0)+i,s=y(f,a),c=A.fullText||r.slice(A.start,A.end);I({...s,text:c,byteOffset:a})},[A,f,n,t]),(0,r.useEffect)(()=>{if(X.current&&(clearTimeout(X.current),X.current=null),!C||!String(C.text||"").trim())return()=>{};if(z.current)return z.current=!1,()=>{};let e=new TextEncoder().encode(C.text||"").length,t="".concat(C.byteOffset,"-").concat(e);if(R&&R[t]&&R[t].last)return()=>{};let n=(null==N?void 0:N.length)==="medium"?"more":(null==N?void 0:N.length)==="large"?"more":"brief";return X.current=setTimeout(()=>{eM({mode:n,length:(null==N?void 0:N.length)||"brief"}),X.current=null},0),()=>{X.current&&(clearTimeout(X.current),X.current=null)}},[C,R,null==N?void 0:N.length]),(0,r.useEffect)(()=>{let e=()=>{var e;if(!f||!n||!t)return;if((location.hash||"").includes("action=settings")){H(!0);let e=new URL(window.location.href);e.hash="",window.history.replaceState(null,"",e.toString());return}if((location.hash||"").includes("action=toc")){eh(!0);let e=new URL(window.location.href);e.hash="",window.history.replaceState(null,"",e.toString());return}let l=function(e){let t=/^#sel=(\d+)-(\d+)$/.exec(e||"");return t?{byteOffset:parseInt(t[1],10),length:parseInt(t[2],10)}:null}(location.hash);if(!l)return;let{byteOffset:o,length:r}=l,i=0;for(let e=0;e<n.length&&n[e].startOffset<=o;e++)i=e;let a=t[i]||"",s=Math.max(0,o-((null===(e=n[i])||void 0===e?void 0:e.startOffset)||0)),c=x(a,s),u=x(a,s+r);u>c&&M({sectionIndex:i,start:c,end:u});let d=ea.current[i];d&&setTimeout(()=>d.scrollIntoView({behavior:"smooth",block:"start"}),50)};return e(),window.addEventListener("hashchange",e),()=>window.removeEventListener("hashchange",e)},[f,n,t]);let[eS,eO]=(0,r.useState)(!1),[eE,ej]=(0,r.useState)(!1);(0,r.useEffect)(()=>{let e=()=>H(!0);return window.addEventListener("open-settings",e),()=>{window.removeEventListener("open-settings",e)}},[]),(0,r.useEffect)(()=>{try{let e=localStorage.getItem("explanations");e&&F(JSON.parse(e))}catch(e){}eO(!0);try{let e=localStorage.getItem("llmOptions");e&&L(JSON.parse(e));let t=localStorage.getItem("noteThreshold");if(null!=t&&""!==t){let e=parseInt(t,10);Number.isFinite(e)&&e>=0&&e<=100&&_(e)}}catch(e){}ej(!0)},[]),(0,r.useEffect)(()=>{if(eS)try{localStorage.setItem("explanations",JSON.stringify(R))}catch(e){}},[eS,R]),(0,r.useEffect)(()=>{if(eE)try{localStorage.setItem("llmOptions",JSON.stringify(N))}catch(e){}},[eE,N]),(0,r.useEffect)(()=>{if(eE&&"number"==typeof B)try{localStorage.setItem("noteThreshold",String(B))}catch(e){}},[eE,B]),(0,r.useEffect)(()=>{let e=e=>{let t=(null==e?void 0:e.detail)||{},n=null;"number"==typeof t.threshold?n=t.threshold:"number"==typeof t.value?n=t.value:"number"==typeof t.density&&(n=s(t.density)),"number"==typeof n&&Number.isFinite(n)&&_(e=>{let t=a(n,0,100);return e===t?e:t})};return window.addEventListener("note-threshold-set",e),()=>window.removeEventListener("note-threshold-set",e)},[]),(0,r.useEffect)(()=>{window.dispatchEvent(new CustomEvent("note-threshold-updated",{detail:{threshold:B,density:c(B)}}))},[B]);let ek=(0,r.useMemo)(()=>{if(!C)return null;let e=new TextEncoder().encode(C.text||"").length;return"".concat(C.byteOffset,"-").concat(e)},[C]),eT=(0,r.useMemo)(()=>Object.entries(R||{}).filter(e=>{let[,t]=e;return t&&t.meta&&t.last}).map(e=>{let[t,n]=e;return{id:t,meta:n.meta,content:n.last}}).sort((e,t)=>(e.meta.byteOffset||0)-(t.meta.byteOffset||0)),[R]);(0,r.useMemo)(()=>ek?eT.findIndex(e=>e.id===ek):-1,[eT,ek]),(0,r.useEffect)(()=>{window.dispatchEvent(new CustomEvent("search-state",{detail:{count:j,index:j?O+1:0,submitted:!!m}}))},[j,O,m]),(0,r.useEffect)(()=>{let e=e=>{var t;return g(((null===(t=e.detail)||void 0===t?void 0:t.query)||"").trim())},t=()=>et(),n=()=>en();return window.addEventListener("search-submit",e),window.addEventListener("search-prev",t),window.addEventListener("search-next",n),()=>{window.removeEventListener("search-submit",e),window.removeEventListener("search-prev",t),window.removeEventListener("search-next",n)}},[j,O]);let eA=(0,r.useCallback)(e=>{e&&F(t=>{if(!t)return t;let n=!1,l={};for(let[r,i]of Object.entries(t)){var o;if((null==i?void 0:null===(o=i.meta)||void 0===o?void 0:o.speechKey)===e){n=!0;continue}l[r]=i}return n?l:t})},[]);async function eM(e){var l,o,r,a,s;let{mode:c="brief",followup:u,length:d}=e;if(!C)return;D(!0);let h=R[ek]||{messages:[]},p=(()=>{if(A&&"number"==typeof A.sectionIndex)return A.sectionIndex;let e=null==C?void 0:C.byteOffset;if(!Number.isFinite(e))return null;for(let l=n.length-1;l>=0;l--){var t;if(e>=((null===(t=n[l])||void 0===t?void 0:t.startOffset)||0))return l}return n.length?0:null})(),m=null;try{let e=null!==(l=C.byteOffset)&&void 0!==l?l:null;if(null!=e&&null!=p){let t=(null==eo?void 0:null===(o=eo.speechesBySection)||void 0===o?void 0:o.get(p))||[],n=null;for(let l of t)if((l.offset||0)<=e)n=l;else break;n&&(m="".concat(n.act,"|").concat(n.scene,"|").concat(n.speechIndex))}}catch(e){}let v=A&&"number"==typeof A.start&&"number"==typeof A.end?A:null,g=new TextEncoder,{start:y,end:w}=(()=>{var e,l,o;let r={start:null!==(l=null==v?void 0:v.start)&&void 0!==l?l:null,end:null!==(o=null==v?void 0:v.end)&&void 0!==o?o:null};if(null!=r.start&&null!=r.end||null==p)return r;let i=t[p]||"",a=(null===(e=n[p])||void 0===e?void 0:e.startOffset)||0;if(!i)return r;let s=Math.max(0,(C.byteOffset||0)-a),c=x(i,s),u=x(i,s+g.encode(C.text||"").length);return{start:null!=r.start?r.start:c,end:null!=r.end?r.end:u}})(),b={sectionIndex:p,start:y,end:w,text:C.text,act:C.act,scene:C.scene,speaker:C.speaker,onStage:C.onStage,byteOffset:C.byteOffset,speechKey:m};R[ek]&&R[ek].last||F({...R,[ek]:{messages:h.messages,last:"AI is thinking…",meta:b}});try{let e="";try{let l=C.byteOffset||0,o=new TextEncoder,i=(Array.isArray(null==f?void 0:f.scenes)?f.scenes:[]).find(e=>l>=(e.startOffset||0)&&l<=(e.endOffset||0)),c=null!==(r=null==i?void 0:i.startOffset)&&void 0!==r?r:0,u=null!==(a=null==i?void 0:i.endOffset)&&void 0!==a?a:l,d=Array.isArray(null==f?void 0:f.speeches)?f.speeches:[],h=null,p=null;for(let e=0;e<d.length;e++){let t=(null===(s=d[e])||void 0===s?void 0:s.offset)||0;if(t>=c&&t<l&&(h=t),t>l&&t<=u){p=t;break}}if(null!=h){let r=Math.min(null!=p?p:u,l),i="";for(let e=0;e<n.length;e++){let l=n[e].startOffset||0,a=t[e]||"",s=l+o.encode(a).length;if(s<=h)continue;if(l>=r)break;let c=Math.max(h,l),u=Math.min(r,s);if(u>c){let e=x(a,c-l),t=x(a,u-l);i+=a.slice(e,t)}}e=i}}catch(e){}let l="";try{let e=C.act,t=C.scene,n=C.byteOffset||0,o=(Array.isArray(null==f?void 0:f.scenes)?f.scenes:[]).find(n=>n.act===e&&String(n.scene)===String(t));if(o&&Array.isArray(null==f?void 0:f.speeches)){let r=0;for(let e of f.speeches){let t=(null==e?void 0:e.offset)||0;t>=(o.startOffset||0)&&t<=n&&r++}if(r>0&&eo&&eo.noteBySpeechKey){let n="".concat(e,"|").concat(t,"|").concat(r),o=eo.noteBySpeechKey.get(n);o&&o.content&&(l=String(o.content))}}}catch(e){}let o=await fetch((0,i.k)("/api/explain"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selectionText:C.text,context:{act:C.act,scene:C.scene,speaker:C.speaker,onStage:C.onStage},contextText:e,noteText:l,options:N,messages:h.messages,mode:c,followup:u})}),p=await o.json();if(!o.ok)throw Error((null==p?void 0:p.detail)||(null==p?void 0:p.error)||"LLM error");let m={role:"assistant",content:p.content},v=d||N.length||"brief",g=[...h.messages,{role:"user",content:function(e,t,n,l){let o=['Explain the selected Romeo and Juliet line(s) directly — no prefaces like "In this quote", and do not repeat the quote or restate Act/Scene/Speaker.',"Help the reader parse the sentence: briefly clarify unfamiliar/archaic words or idioms and any tricky syntax (inversions, ellipses), then give a clear paraphrase.",'Avoid boilerplate claims ("pivotal", "foreshadows", "underscores the theme", "sets the stage") unless clearly warranted by these exact lines; be concrete or skip such claims.',"Prefer precise paraphrase + immediate purpose in the scene.","Assume adjacent paragraphs may also have explanations: do not repeat the same theme or scene-level plot point that a neighboring note would already cover; focus on what is new or specific to these exact lines.","If these lines merely continue an idea already explained in the previous passage, add only the fresh detail and keep it short."],r=(l||"").toLowerCase();return("brief"===t||"brief"===r)&&o.push("Length: brief (2–3 sentences)."),"medium"===r&&o.push("Length: medium (concise paragraph)."),("more"===t||"large"===r)&&o.push("Length: large (detailed but focused)."),"followup"===t&&n&&o.push("Follow-up: ".concat(n)),o.join("\n")}(0,c,u,v)},m].slice(-12);F({...R,[ek]:{messages:g,last:p.content,meta:b}})}catch(e){F({...R,[ek]:{messages:[],last:"Error: ".concat(String(e.message||e)),meta:b}})}finally{D(!1)}}let[eC,eI]=(0,r.useState)([]),eN=(0,r.useRef)(N.provider||"openai");function eL(e){if(eC&&eC.length)return eC[0];let t=(e||"openai").toLowerCase();return"anthropic"===t?"claude-3-5-sonnet-20240620":"deepseek"===t?"deepseek-chat":"gemini"===t?"gemini-1.5-pro-latest":"gpt-4o-mini"}return(0,r.useEffect)(()=>{let e=(N.provider||"openai").toLowerCase();eN.current=e,fetch((0,i.k)("/api/models?provider=".concat(encodeURIComponent(e)))).then(e=>e.json()).then(t=>{let n=Array.isArray(null==t?void 0:t.models)&&t.models.length?t.models:[];eN.current===e&&eI(n)}).catch(()=>eI([]))},[N.provider]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(o,{children:[(0,l.jsx)("title",{children:"Romeo and Juliet — Explained"}),(0,l.jsx)("meta",{name:"description",content:"Romeo and Juliet text with space for explanations."})]}),(0,l.jsxs)("div",{className:"page",children:[(0,l.jsx)("nav",{className:"sidebar",children:(0,l.jsxs)("div",{className:"toc",children:[(0,l.jsx)("h2",{children:"Contents"}),el.map(e=>(0,l.jsx)("div",{children:"Prologue"===e.act?(0,l.jsx)("ul",{children:(()=>{let t=e.scenes[0],n="".concat(t.act,"-").concat(t.scene);return(0,l.jsx)("li",{className:er===n?"active":"",children:(0,l.jsx)("a",{href:"#",onClick:e=>{e.preventDefault(),ew(t.sectionIndex)},title:"Prologue",children:"Prologue"})},"scene-".concat(n))})()}):(0,l.jsxs)("ul",{children:[(0,l.jsx)("li",{style:{fontWeight:600,color:"#53483e",fontFamily:"IM Fell English, serif"},children:"Act ".concat(e.act)}),e.scenes.map(e=>{let t="".concat(e.act,"-").concat(e.scene);return(0,l.jsx)("li",{className:er===t?"active":"",children:(0,l.jsx)("a",{href:"#",onClick:t=>{t.preventDefault(),ew(e.sectionIndex)},title:"Act ".concat(e.act,", Scene ").concat(e.scene),children:e.title})},"scene-".concat(t))})]})},"act-".concat(e.act)))]})}),(0,l.jsx)("main",{className:"container",children:t.map((e,t)=>{var o;let r=Object.entries(R||{}).filter(e=>{let[n,l]=e;return l&&l.meta&&l.meta.sectionIndex===t&&l.last}).map(e=>{let[,t]=e;return t}).sort((e,t)=>{var n,l,o,r,i,a,s,c;let u=null!==(i=null===(n=e.meta)||void 0===n?void 0:n.start)&&void 0!==i?i:0,d=null!==(a=null===(l=t.meta)||void 0===l?void 0:l.start)&&void 0!==a?a:0;return u!==d?u-d:(null!==(s=null===(o=e.meta)||void 0===o?void 0:o.byteOffset)&&void 0!==s?s:0)-(null!==(c=null===(r=t.meta)||void 0===r?void 0:r.byteOffset)&&void 0!==c?c:0)}),i=(null===(o=n[t])||void 0===o?void 0:o.startOffset)||0,a=(eo.speechesBySection.get(t)||[]).map(e=>eo.noteBySpeechKey.get("".concat(e.act,"|").concat(e.scene,"|").concat(e.speechIndex))).filter(Boolean),s=a.filter(e=>{let t=function(e){var t,n;let l=Number(null!==(n=null!==(t=null==e?void 0:e.perplexity)&&void 0!==t?t:null==e?void 0:e.confusion)&&void 0!==n?n:0);(!Number.isFinite(l)||l<0)&&(l=0);let o=String((null==e?void 0:e.perplexityModel)||"").toLowerCase();return"number"==typeof(null==e?void 0:e.perplexityNorm)?Math.round(Math.max(0,Math.min(100,e.perplexityNorm))):l<=100&&"gpt2"!==o?Math.max(0,Math.min(100,l)):Math.max(0,Math.min(100,Math.round(25*Math.log10(Math.max(1,l)))))}(e);return"number"!=typeof B||B<=0||t>=B});return(0,l.jsx)(v,{text:e,query:m,matchRefs:T,precomputedItems:s,precomputedAllItems:a,speeches:eo.speechesBySection.get(t)||[],noteBySpeechKey:eo.noteBySpeechKey,selectedRange:A&&A.sectionIndex===t?{start:A.start,end:A.end}:null,onSelectRange:e=>{M(e?{sectionIndex:t,...e}:null)},sectionRef:e=>ea.current[t]=e,contextInfo:A&&A.sectionIndex===t?C:null,sectionIndex:t,sectionStartOffset:i,suppressNextAutoExplain:z,metadata:f,forcedNotes:G,onToggleForced:ee,noteThreshold:B,onRequestFocus:e=>ec(e),onDeleteSpeech:eA,llm:{options:N,setOptions:L,loading:P,conversation:ek?R[ek]:null,onLength:e=>eM({mode:"brief"===e?"brief":"more",length:e}),onFollowup:e=>eM({mode:"followup",followup:e}),onDeleteCurrent:()=>{ek&&(function(e){let t={...R};delete t[e],F(t)}(ek),M(null))}},selectedId:A&&A.sectionIndex===t?ek:null,pendingFocus:es&&es.sectionIndex===t?es:null,onPendingFocusConsumed:()=>ec(null),savedExplanations:r,onDeleteSaved:e=>{let t={...R||{}};delete t[e],F(t)},onCopyLink:()=>{var e;if(!C)return;let t=new TextEncoder().encode(C.text||"").length,n=w(C.byteOffset,t);null===(e=navigator.clipboard)||void 0===e||e.writeText(n)},noteInSelectMode:$,onToggleNoteSelectMode:e=>{Z(t=>t===e?null:e)}},t)})}),(0,l.jsx)("button",{type:"button",className:"backToToc ".concat(eu?"show":""),onClick:eb,title:"Back to contents","aria-label":"Back to contents",children:"↑"}),ef&&(0,l.jsx)("div",{className:"tocPopupOverlay",onClick:()=>eh(!1),children:(0,l.jsxs)("div",{className:"tocPopupPanel",onClick:e=>e.stopPropagation(),role:"dialog","aria-label":"Contents",children:[(0,l.jsxs)("div",{className:"tocPopupHeader",children:[(0,l.jsx)("span",{style:{fontWeight:600,fontSize:"1.1em"},children:"Contents"}),(0,l.jsx)("button",{type:"button",className:"closeBtn",onClick:()=>eh(!1),"aria-label":"Close contents",children:"✕"})]}),(0,l.jsx)("div",{className:"toc",style:{maxHeight:"70vh",overflowY:"auto"},children:el.map(e=>(0,l.jsx)("div",{children:"Prologue"===e.act?(0,l.jsx)("ul",{children:(()=>{let t=e.scenes[0],n="".concat(t.act,"-").concat(t.scene);return(0,l.jsx)("li",{className:er===n?"active":"",children:(0,l.jsx)("a",{href:"#",onClick:e=>{e.preventDefault(),eh(!1),ew(t.sectionIndex)},title:"Prologue",children:"Prologue"})},"p-scene-".concat(n))})()}):(0,l.jsxs)("ul",{children:[(0,l.jsx)("li",{style:{fontWeight:600,color:"#53483e",fontFamily:"IM Fell English, serif"},children:"Act ".concat(e.act)}),e.scenes.map(e=>{let t="".concat(e.act,"-").concat(e.scene);return(0,l.jsx)("li",{className:er===t?"active":"",children:(0,l.jsx)("a",{href:"#",onClick:t=>{t.preventDefault(),eh(!1),ew(e.sectionIndex)},title:"Act ".concat(e.act,", Scene ").concat(e.scene),children:e.title})},"p-scene-".concat(t))})]})},"p-act-".concat(e.act)))})]})})]}),q&&(0,l.jsx)("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.3)",zIndex:50},onClick:()=>H(!1),children:(0,l.jsxs)("div",{style:{background:"#fff",maxWidth:560,margin:"10vh auto",padding:"1rem",borderRadius:8,border:"1px solid #ddd"},onClick:e=>e.stopPropagation(),children:[(0,l.jsx)("h3",{style:{marginTop:0},children:"Settings"}),(0,l.jsxs)("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap",alignItems:"center"},children:[(0,l.jsxs)("label",{children:["Provider",(0,l.jsxs)("select",{value:N.provider||"openai",onChange:e=>{let t=e.target.value,n=eL(t);L({...N,provider:t,model:n})},style:{marginLeft:6},children:[(0,l.jsx)("option",{value:"openai",children:"OpenAI"}),(0,l.jsx)("option",{value:"anthropic",children:"Anthropic"}),(0,l.jsx)("option",{value:"deepseek",children:"DeepSeek"}),(0,l.jsx)("option",{value:"gemini",children:"Gemini"})]})]}),(0,l.jsxs)("label",{children:["Model",(0,l.jsx)("select",{value:eC.includes(N.model)?N.model:eL(N.provider),onChange:e=>L({...N,model:e.target.value}),style:{marginLeft:6},children:(eC.length?eC:[eL(N.provider)]).map(e=>(0,l.jsx)("option",{value:e,children:e},e))})]}),(0,l.jsxs)("label",{children:["Language",(0,l.jsx)("input",{type:"text",value:N.language||"",onChange:e=>L({...N,language:e.target.value}),style:{marginLeft:6}})]}),(0,l.jsxs)("label",{children:["Default length",(0,l.jsxs)("select",{value:N.length||"brief",onChange:e=>L({...N,length:e.target.value}),style:{marginLeft:6},children:[(0,l.jsx)("option",{value:"brief",children:"Brief"}),(0,l.jsx)("option",{value:"medium",children:"Medium"}),(0,l.jsx)("option",{value:"large",children:"Large"})]})]}),(0,l.jsxs)("label",{children:["Education",(0,l.jsxs)("select",{value:N.educationLevel||"High school",onChange:e=>L({...N,educationLevel:e.target.value}),style:{marginLeft:6},children:[(0,l.jsx)("option",{children:"Middle school"}),(0,l.jsx)("option",{children:"High school"}),(0,l.jsx)("option",{children:"Undergraduate"}),(0,l.jsx)("option",{children:"Graduate"})]})]}),(0,l.jsxs)("label",{children:["Age",(0,l.jsx)("input",{type:"number",min:"10",max:"100",value:N.age||"",onChange:e=>L({...N,age:e.target.value}),style:{marginLeft:6,width:72}})]})]}),(0,l.jsxs)("div",{style:{marginTop:"0.75rem",textAlign:"right"},children:[(0,l.jsx)("button",{type:"button",onClick:()=>{try{if(!window.confirm("Remove all saved explanations? This cannot be undone."))return}catch(e){}F({});try{localStorage.setItem("explanations",JSON.stringify({}))}catch(e){}try{null==V||V([])}catch(e){}try{localStorage.setItem("forcedNotes",JSON.stringify([]))}catch(e){}try{_(100),localStorage.setItem("noteThreshold",String(100))}catch(e){}},style:{marginRight:8},title:"Remove all saved explanations",children:"Remove All Explanations"}),(0,l.jsx)("button",{type:"button",onClick:()=>H(!1),children:"Close"})]})]})})]})}function v(e){var t,n,o;let{text:a,query:s,matchRefs:c,sectionRef:u,selectedRange:d,onSelectRange:f,contextInfo:p,llm:m,savedExplanations:v=[],onCopyLink:E,selectedId:j,pendingFocus:k,onPendingFocusConsumed:T,precomputedItems:A=[],precomputedAllItems:M=[],speeches:C=[],noteBySpeechKey:I=new Map,sectionIndex:N=0,sectionStartOffset:L=0,onDeleteSaved:R,onDeleteSpeech:F,suppressNextAutoExplain:P,metadata:D,noteThreshold:q=0,forcedNotes:H=[],onToggleForced:B,onRequestFocus:_,noteInSelectMode:W=null,onToggleNoteSelectMode:J}=e,Y=(0,r.useRef)(null),K=(0,r.useRef)(null),U=(0,r.useRef)(!1);(0,r.useRef)(!1);let z=(0,r.useRef)(!1);(0,r.useRef)(null),(0,r.useRef)(null),(0,r.useRef)(!1);let X=(0,r.useRef)({x:0,y:0}),G=(0,r.useRef)(null),V=(0,r.useRef)(!1),$=(0,r.useRef)(0),[Z,Q]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if("undefined"!=typeof navigator)try{navigator.maxTouchPoints>0&&Q(!0)}catch(e){}},[]);let ee=W||Z,et=W&&C.some(e=>"".concat(e.act,"|").concat(e.scene,"|").concat(e.speechIndex)===W),en=!!et,el=(0,r.useRef)(null),eo=(0,r.useRef)({x:0,y:0}),[er,ei]=(0,r.useState)(0),[ea,es]=(0,r.useState)(!1),[ec,eu]=(0,r.useState)(""),[ed,ef]=(0,r.useState)(!1),eh=(0,r.useRef)(!1),[ep,em]=(0,r.useState)({}),[ev,eg]=(0,r.useState)(!1),[ey,ex]=(0,r.useState)(new Set),ew=(0,r.useMemo)(()=>new TextEncoder,[]);function eb(e){try{let t=Math.max(0,(e.startOffset||0)-L),n=Math.max(t+1,(e.endOffset||(e.startOffset||0)+1)-L),l=x(a||"",t),o=x(a||"",n),r=(a||"").slice(l,o).trim();if(!r)return!1;let i=/[A-Z]/.test(r),s=/[a-z]/.test(r);if(i&&!s||/^(Enter|Re-enter|Exit|Exeunt)\b/i.test(r))return!0;return!1}catch(e){return!1}}(0,r.useEffect)(()=>{try{let e=window.localStorage.getItem("noteThreads");if(e){let t=JSON.parse(e);t&&"object"==typeof t&&em(t)}}catch(e){}},[]),(0,r.useEffect)(()=>{try{window.localStorage.setItem("noteThreads",JSON.stringify(ep))}catch(e){}},[ep]);let eS=(A||[]).filter(e=>!eb(e)),eO=(M||[]).filter(e=>!eb(e)),eE=e=>{if(!e||!C||!C.length)return null;for(let t of C){let n="".concat(t.act,"|").concat(t.scene,"|").concat(t.speechIndex),l=I.get(n);if(l&&l.startOffset===(e.startOffset||0))return n}return null},ej=eS.filter(e=>{let t=eE(e);return!t||!ey.has(t)}),ek=eO.filter(e=>{let t=eE(e);return!t||!ey.has(t)});function eT(e,t){if(!e||!e.length)return null;let n=e.length,l=Math.max(0,Math.min(t||0,n-1));for(let t=l;t<n;t++)if(e[t])return e[t];for(let t=l-1;t>=0;t--)if(e[t])return e[t];return null}let eA=eT(ej,er),eM=eT(ek,er),eC=new Set((Array.isArray(H)?H:[]).map(String)),eI=C&&C.length?C[Math.min(er,C.length-1)]:null,eN=eI?"".concat(eI.act,"|").concat(eI.scene,"|").concat(eI.speechIndex):null,eL=(C||[]).find(e=>eC.has("".concat(e.act,"|").concat(e.scene,"|").concat(e.speechIndex))),eR=eL?"".concat(eL.act,"|").concat(eL.scene,"|").concat(eL.speechIndex):null,eF=eN&&ey.has(eN),eP=eR&&ey.has(eR),eD=eR&&!eP?I.get(eR):eF?null:eA||(ev?eM:null),eq=d&&((null==m?void 0:null===(t=m.conversation)||void 0===t?void 0:t.last)||(null==m?void 0:m.loading)),eH=!!d,eB=!!et,e_=!!eD||v&&v.length>0||eq||eH||eB,eW=!d&&(!v||0===v.length)&&!eA&&!!eM,eJ=!!(d&&p),eY=null==m?void 0:null===(n=m.conversation)||void 0===n?void 0:n.last,eK=eJ&&(null==m?void 0:m.loading)&&(!eY||"AI is thinking…"===eY),eU=eJ&&eY&&"AI is thinking…"!==eY,ez=eJ?(()=>{let e=ew.encode(p.text||"").length;return"".concat(p.byteOffset,"-").concat(e)})():null,eX=(v||[]).filter(e=>{if(!ez||!(null==e?void 0:e.meta))return!0;let t=ew.encode(e.meta.text||"").length;return"".concat(e.meta.byteOffset,"-").concat(t)!==ez}),eG=eJ&&p&&null!==(o=p.byteOffset)&&void 0!==o?o:null,eV=eJ&&p&&p.text?ew.encode(p.text).length:0,e$=null!=eG?eG+eV:null,eZ=(0,r.useMemo)(()=>{var e,t;if(!eJ||null==eG)return null;let n=Array.isArray(null==D?void 0:D.speeches)?D.speeches:[];if(!n.length)return null;let l=-1;for(let t=0;t<n.length;t++)if(((null===(e=n[t])||void 0===e?void 0:e.offset)||0)<=eG)l=t;else break;if(l<0)return null;let o=n[l].offset||0,r=null;for(let e=l+1;e<n.length;e++){let l=null===(t=n[e])||void 0===t?void 0:t.offset;if(null!=l&&l>o){r=l;break}}if(null==r){let e=((null==D?void 0:D.scenes)||[]).find(e=>o>=(e.startOffset||0)&&o<(e.endOffset||0));e&&null!=e.endOffset&&(r=e.endOffset)}return(null==r||r<=o)&&(r=o+eV),{start:o,end:r}},[eJ,D,eG,eV]),eQ=(0,r.useMemo)(()=>{if(!eZ||null==eG||null==e$)return!1;let e=Math.abs(eG-eZ.start),t=Math.abs(e$-eZ.end);return e<=4&&t<=4},[eZ,eG,e$]),e0=eJ&&p&&!eQ&&(p.text||"").trim()||null,e1=e=>e?(0,l.jsx)("div",{style:{marginBottom:"0.5rem",paddingLeft:"1rem",borderLeft:"3px solid #e8d8b5",fontStyle:"italic",color:"#4a4036",whiteSpace:"pre-wrap"},children:e}):null,e5=(()=>{if(!(et&&eD&&!eJ))return null;let e=async()=>{try{ef(!0);let e=Math.max(0,(eD.startOffset||0)-L),t=Math.max(e+1,(eD.endOffset||(eD.startOffset||0)+1)-L),n=x(a||"",e),l=x(a||"",t),o=(a||"").slice(n,l),r=y(D||{},eD.startOffset||0),s=(eD.content||"").trim(),c=await fetch((0,i.k)("/api/explain"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selectionText:o,context:{act:r.act,scene:r.scene,speaker:r.speaker,onStage:r.onStage},options:null==m?void 0:m.options,messages:[],mode:"followup",followup:s?'Provide additional insight that builds on the existing explanation below without repeating or paraphrasing it. Focus on new details, clarifying tricky references, or subtle dramatic function.\nExisting explanation:\n"""'.concat(s,'"""'):"Please expand this into a longer explanation with more detail while avoiding repetition."})}),u=await c.json();if(!c.ok)throw Error((null==u?void 0:u.detail)||(null==u?void 0:u.error)||"LLM error");let d=((null==u?void 0:u.content)||"").trim(),f=String(eD.startOffset||0);em(e=>{var t,n;let l=Array.isArray(e[f])?e[f].slice():[];return l.push({q:"More detail",a:d,model:(null==m?void 0:null===(t=m.options)||void 0===t?void 0:t.model)||"",provider:(null==m?void 0:null===(n=m.options)||void 0===n?void 0:n.provider)||""}),{...e,[f]:l}})}catch(t){let e=String(eD.startOffset||0);em(n=>{var l,o;let r=Array.isArray(n[e])?n[e].slice():[];return r.push({q:"More detail",a:"Error: ".concat(String(t.message||t)),model:(null==m?void 0:null===(l=m.options)||void 0===l?void 0:l.model)||"",provider:(null==m?void 0:null===(o=m.options)||void 0===o?void 0:o.provider)||""}),{...n,[e]:r}})}finally{ef(!1)}},t=async e=>{try{ef(!0);let t=Math.max(0,(eD.startOffset||0)-L),n=Math.max(t+1,(eD.endOffset||(eD.startOffset||0)+1)-L),l=x(a||"",t),o=x(a||"",n),r=(a||"").slice(l,o),s=y(D||{},eD.startOffset||0),c=await fetch((0,i.k)("/api/explain"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selectionText:r,context:{act:s.act,scene:s.scene,speaker:s.speaker,onStage:s.onStage},options:null==m?void 0:m.options,messages:[],mode:"followup",followup:e})}),u=await c.json();if(!c.ok)throw Error((null==u?void 0:u.detail)||(null==u?void 0:u.error)||"LLM error");let d=((null==u?void 0:u.content)||"").trim(),f=String(eD.startOffset||0);em(t=>{var n,l;let o=Array.isArray(t[f])?t[f].slice():[];return o.push({q:e,a:d,model:(null==m?void 0:null===(n=m.options)||void 0===n?void 0:n.model)||"",provider:(null==m?void 0:null===(l=m.options)||void 0===l?void 0:l.provider)||""}),{...t,[f]:o}})}catch(n){let t=String(eD.startOffset||0);em(l=>{var o,r;let i=Array.isArray(l[t])?l[t].slice():[];return i.push({q:e,a:"Error: ".concat(String(n.message||n)),model:(null==m?void 0:null===(o=m.options)||void 0===o?void 0:o.model)||"",provider:(null==m?void 0:null===(r=m.options)||void 0===r?void 0:r.provider)||""}),{...l,[t]:i}})}finally{ef(!1)}};return(0,l.jsxs)("div",{style:{marginTop:"0.5rem",paddingTop:"0.25rem",borderTop:"1px solid #eee"},children:[(0,l.jsx)("div",{style:{fontSize:"0.9em",color:"#6b5f53",fontStyle:"italic",marginBottom:"0.5rem"},children:"You can select text in the play to ask about it, or ask a follow-up about this note below."}),(0,l.jsx)(S,{contextInfo:p,llm:{...m,loading:ed},onRequestFocus:()=>{},noteMode:!0,onNoteMore:e,onNoteFollowup:t})]})})(),e2=eJ?(0,l.jsxs)("div",{style:{marginTop:eD?"0.5rem":"0.25rem",paddingTop:eD?"0.25rem":"0",borderTop:eD?"1px solid #eee":"none"},children:[e1(e0&&!eU?e0:null),eK?(0,l.jsx)("div",{style:{marginBottom:"0.5rem",color:"#6b5f53"},children:"Thinking…"}):null,(0,l.jsx)(S,{contextInfo:p,llm:m,onRequestFocus:()=>{if(d&&p&&_){let e=ew.encode(p.text||"").length;_({sectionIndex:N,id:"".concat(p.byteOffset,"-").concat(e)})}}})]}):null,e3=eU?(0,l.jsxs)("div",{style:{marginTop:e5||e2?"0.5rem":eD?"0.5rem":"0.25rem",paddingTop:"0.25rem",paddingRight:"32px",borderTop:"1px solid #eee"},children:[(0,l.jsx)("div",{style:{fontWeight:600,marginBottom:"0.25rem"},children:"Explanation"}),e1(e0&&eU?e0:null),(0,l.jsx)("div",{style:{whiteSpace:"pre-wrap"},children:eY}),(()=>{var e,t,n;let o=h((null==m?void 0:null===(e=m.options)||void 0===e?void 0:e.provider)||""),r="";return(null==m?void 0:null===(t=m.options)||void 0===t?void 0:t.model)&&o?r="".concat(m.options.model," (via ").concat(o,")"):(null==m?void 0:null===(n=m.options)||void 0===n?void 0:n.model)?r="Model: ".concat(m.options.model):o&&(r=o),r?(0,l.jsx)("div",{style:{fontStyle:"italic",fontSize:"0.85em",color:"#6b5f53",marginTop:4},children:r}):null})()]}):null,e8=eX.length>0?(0,l.jsx)("div",{style:{marginTop:e3||e2||e5?"0.75rem":"0.5rem"},children:eX.map((e,t)=>{let n=(null==e?void 0:e.meta)||{},o=(()=>{let e=(n.text||"").trim();if(e)return e;let t=Number.isFinite(n.start)?n.start:null,l=Number.isFinite(n.end)?n.end:null;return null!=t&&null!=l&&l>t?(a||"").slice(t,l).trim():""})();return(0,l.jsx)(O,{passage:o,content:(null==e?void 0:e.last)||"",meta:n,options:null==m?void 0:m.options,onLocate:()=>{if(null!=n.start&&null!=n.end){f({start:n.start,end:n.end});let e=ew.encode(n.text||o||"").length,t="".concat(n.byteOffset,"-").concat(e);null==_||_({sectionIndex:N,id:t})}},onCopy:()=>{if(null!=n.byteOffset){var e;let t=ew.encode(n.text||o||"").length,l=w(n.byteOffset,t);null===(e=navigator.clipboard)||void 0===e||e.writeText(l)}},onDelete:()=>{if(null!=n.byteOffset){let e=ew.encode(n.text||o||"").length,t="".concat(n.byteOffset,"-").concat(e);null==R||R(t)}}},"ex-".concat(t,"-").concat(n.byteOffset||t))})}):null;(0,r.useEffect)(()=>{let e=eA||eM,t=e?eE(e):null;if(!t){eg(!1);return}eg(Array.isArray(H)&&H.map(String).includes(String(t)))},[er,eA,eM,H]);let e6=()=>{eN&&(ey.has(eN)&&ex(e=>{let t=new Set(e);return t.delete(eN),t}),B&&B(eN,N))},e4=()=>{try{let e=null==K?void 0:K.current;if(!e)return;e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"});try{e.classList.add("flash"),setTimeout(()=>e.classList.remove("flash"),900)}catch(e){}}catch(e){}};(0,r.useEffect)(()=>()=>{clearTimeout(G.current)},[]),(0,r.useEffect)(()=>{var e,t;let n=M&&M.length?M:A&&A.length?A:[];if(!n||!n.length)return;let l=(null==u?void 0:null===(t=u.current)||void 0===t?void 0:null===(e=t.querySelectorAll)||void 0===e?void 0:e.call(t,":scope .speechAnchor"))||[];if(!l.length)return;let o=function(){let e=document.querySelector(".container");if(e&&e.scrollHeight>e.clientHeight+1)return e;let t=document.querySelector(".page");return t&&t.scrollHeight>t.clientHeight+1?t:null}(),r=new IntersectionObserver(e=>{let t=null;for(let n of e){if(!n.isIntersecting)continue;let e=parseInt(n.target.getAttribute("data-idx")||"0",10)||0,l=Math.abs(n.boundingClientRect.top-(o?o.getBoundingClientRect().top+.25*o.clientHeight:0));(!t||l<t.score)&&(t={idx:e,score:l})}t&&ei(t.idx)},{root:o||void 0,threshold:[0,.01,.1]});return l.forEach(e=>r.observe(e)),()=>r.disconnect()},[M,A,u]);let e7=e=>{let t=Y.current;if(!t)return;let n=null;e&&(n=t.querySelector('.selected[data-sel-id="'.concat(e,'"]'))),n&&n&&(n.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),n.classList.add("flash"),setTimeout(()=>n.classList.remove("flash"),1800))};(0,r.useEffect)(()=>{k&&j&&k.id===j&&(e7(j),null==T||T())},[k,j]),(0,r.useEffect)(()=>{U.current&&d&&(U.current=!1,requestAnimationFrame(()=>{var e;let t=null===(e=Y.current)||void 0===e?void 0:e.querySelector(".selected");t&&(t.classList.add("flash"),setTimeout(()=>t.classList.remove("flash"),900))}))},[null==d?void 0:d.start,null==d?void 0:d.end,d,Y]);let e9=(0,r.useMemo)(()=>(function(e,t,n,o,r){if(!n)return g(e,t,o);let i=Math.max(0,Math.min(n.start,n.end)),a=Math.max(i,Math.max(n.start,n.end)),s=e.slice(0,i),c=e.slice(i,a),u=e.slice(a);return[...[].concat(g(s,t,o)),(0,l.jsx)("span",{className:"selected","data-sel-id":r||"",children:g(c,t,o)},"sel"),...[].concat(g(u,t,o))]})(a,s,d,c,j),[a,s,null==d?void 0:d.start,null==d?void 0:d.end,j,c]);return(0,l.jsxs)("div",{className:"section".concat(e_?"":" single"),ref:u,children:[(0,l.jsxs)("div",{className:"playText",style:{position:"relative"},children:[(()=>{let e=(a||"").length||1;return(M&&M.length?M:A&&A.length?A:[]).map((t,n)=>{let o=x(a||"",Math.max(0,(t.startOffset||0)-L));return(0,l.jsx)("div",{className:"speechAnchor","data-idx":n,style:{position:"absolute",top:"".concat(o/Math.max(1,e)*100,"%"),left:0,width:1,height:1,pointerEvents:"none"}},"anch-".concat(n))})})(),(0,l.jsx)("pre",{ref:Y,onMouseUp:e=>{var t,n,l;try{DEBUG_SELECTION&&console.log("mouseUp:text",{sectionIndex:N})}catch(e){}try{if("undefined"!=typeof navigator&&0!==navigator.maxTouchPoints&&navigator.maxTouchPoints>0)return}catch(e){}if(eh.current){eh.current=!1;return}let o=null,r=!1;try{let l=(null==u?void 0:null===(n=u.current)||void 0===n?void 0:null===(t=n.querySelectorAll)||void 0===t?void 0:t.call(n,":scope .speechAnchor"))||[];if(l.length){let t={idx:0,d:1/0},n=(null==e?void 0:e.clientY)||0;l.forEach(e=>{let l=e.getBoundingClientRect(),o=Math.abs((l.top||0)-n),r=parseInt(e.getAttribute("data-idx")||"0",10)||0;o<t.d&&(t={idx:r,d:o})});let i=(C||[])[Math.min(t.idx,Math.max(0,(C||[]).length-1))];i&&(o="".concat(i.act,"|").concat(i.scene,"|").concat(i.speechIndex),r=!!(I&&I.get&&I.get(o)))}}catch(e){}if(!r&&eN&&I&&(o=eN,r=!!(I.get&&I.get(o))),!en&&r){let e=o;if(e){ey.has(e)&&ex(t=>{let n=new Set(t);return n.delete(e),n});let t=eC.has(e);if(B&&B(e,N),t){if(ex(t=>{let n=new Set(t);return n.add(e),n}),F&&F(e),Array.isArray(eX)&&eX.length){let t=new TextEncoder;for(let n of eX){let l=null==n?void 0:n.meta;if(!l)continue;let o=l.speechKey;if(!(o?o===e:l.sectionIndex===N))continue;let r=t.encode(l.text||"").length;null==R||R("".concat(l.byteOffset,"-").concat(r))}}null==m||null===(l=m.onDeleteCurrent)||void 0===l||l.call(m)}}if(window.getSelection)try{let e=window.getSelection();e&&e.removeAllRanges()}catch(e){}"function"==typeof P?P():P&&"object"==typeof P&&(P.current=!0);return}let i=Y.current;if(!i||!window.getSelection)return;let s=window.getSelection();if(!s||0===s.rangeCount)return;let c=s.getRangeAt(0);if(!i.contains(c.startContainer)||!i.contains(c.endContainer))return;let{start:d,end:h}=function(e,t){let n=document.createRange();n.selectNodeContents(e);let l=n.cloneRange();l.setEnd(t.startContainer,t.startOffset);let o=l.toString().length,r=n.cloneRange();return r.setEnd(t.endContainer,t.endOffset),{start:o,end:r.toString().length}}(i,c);if(h>d){U.current=!0,null==f||f({start:d,end:h});return}let p=b(a||"",d);p&&(U.current=!0,null==f||f({start:p.start,end:p.end}))},onTouchStart:e=>{let t=e.touches&&e.touches[0],n=t?t.clientX:0,l=t?t.clientY:0;if(X.current={x:n,y:l},z.current=!1,V.current=!0,eo.current={x:n,y:l},en){try{e.preventDefault(),e.stopPropagation()}catch(e){}try{let e=Y.current,t=((e,t)=>{var n,l;if(document.caretRangeFromPoint)return document.caretRangeFromPoint(e,t);let o=null===(n=(l=document).caretPositionFromPoint)||void 0===n?void 0:n.call(l,e,t);if(o){let e=document.createRange();return e.setStart(o.offsetNode,o.offset),e.collapse(!0),e}return null})(n,l);if(e&&t){let n=document.createRange();n.selectNodeContents(e);let l=n.cloneRange();l.setEnd(t.startContainer,t.startOffset),el.current=l.toString().length}else el.current=null}catch(e){el.current=null}return}try{let e=function(){let e=document.querySelector(".container");if(e&&e.scrollHeight>e.clientHeight+1)return e;let t=document.querySelector(".page");return t&&t.scrollHeight>t.clientHeight+1?t:window}();$.current=e===window?window.scrollY:e.scrollTop}catch(e){$.current=0}},onTouchMove:e=>{let t=e.touches&&e.touches[0];if(t&&(Math.abs((t.clientX||0)-X.current.x)+Math.abs((t.clientY||0)-X.current.y)>6&&(z.current=!0),en)){try{e.preventDefault(),e.stopPropagation()}catch(e){}try{let e=Y.current,n=t.clientX||eo.current.x||0,l=t.clientY||eo.current.y||0,o=null,r=((e,t)=>{var n,l;if(document.caretRangeFromPoint)return document.caretRangeFromPoint(e,t);let o=null===(n=(l=document).caretPositionFromPoint)||void 0===n?void 0:n.call(l,e,t);if(o){let e=document.createRange();return e.setStart(o.offsetNode,o.offset),e.collapse(!0),e}return null})(n,l);if(e&&r){let t=document.createRange();t.selectNodeContents(e);let n=t.cloneRange();n.setEnd(r.startContainer,r.startOffset),o=n.toString().length}let i=el.current;if(Number.isFinite(i)&&Number.isFinite(o)&&z.current){let e=Math.max(0,Math.min(i,o)),t=Math.max(e,Math.max(i,o));t>e&&(null==f||f({start:e,end:t}))}}catch(e){}}},onTouchEnd:e=>{var t,n,l,o,r;try{e.preventDefault(),e.stopPropagation()}catch(e){}if(en){try{let t=Y.current,n=e.changedTouches&&e.changedTouches[0],l=(null==n?void 0:n.clientX)||eo.current.x||0,o=(null==n?void 0:n.clientY)||eo.current.y||0,r=null,i=((e,t)=>{var n,l;if(document.caretRangeFromPoint)return document.caretRangeFromPoint(e,t);let o=null===(n=(l=document).caretPositionFromPoint)||void 0===n?void 0:n.call(l,e,t);if(o){let e=document.createRange();return e.setStart(o.offsetNode,o.offset),e.collapse(!0),e}return null})(l,o);if(t&&i){let e=document.createRange();e.selectNodeContents(t);let n=e.cloneRange();n.setEnd(i.startContainer,i.startOffset),r=n.toString().length}let s=el.current,c=null,u=null;if(Number.isFinite(s)&&Number.isFinite(r)&&z.current)c=Math.max(0,Math.min(s,r)),u=Math.max(c,Math.max(s,r));else{let e=Number.isFinite(r)?r:Number.isFinite(s)?s:null;if(null!=e){let t=b(a||"",e);t&&(c=t.start,u=t.end)}}null!=c&&null!=u&&u>c&&(U.current=!0,null==f||f({start:c,end:u}),J&&W&&J(W),e4())}catch(e){}eh.current=!0,V.current=!1,setTimeout(()=>{z.current=!1},80);return}try{let e=function(){let e=document.querySelector(".container");if(e&&e.scrollHeight>e.clientHeight+1)return e;let t=document.querySelector(".page");return t&&t.scrollHeight>t.clientHeight+1?t:window}(),t=e===window?window.scrollY:e.scrollTop;if(Math.abs(t-($.current||0))>30||z.current){eh.current=!0,V.current=!1,setTimeout(()=>{z.current=!1},80);return}}catch(e){}let i=null,s=!1;try{let r=(null==u?void 0:null===(n=u.current)||void 0===n?void 0:null===(t=n.querySelectorAll)||void 0===t?void 0:t.call(n,":scope .speechAnchor"))||[];if(r.length){let t={idx:0,d:1/0},n=e.changedTouches&&(null===(l=e.changedTouches[0])||void 0===l?void 0:l.clientY)||(null===(o=X.current)||void 0===o?void 0:o.y)||0;r.forEach(e=>{let l=e.getBoundingClientRect(),o=Math.abs((l.top||0)-n),r=parseInt(e.getAttribute("data-idx")||"0",10)||0;o<t.d&&(t={idx:r,d:o})});let a=(C||[])[Math.min(t.idx,Math.max(0,(C||[]).length-1))];a&&(i="".concat(a.act,"|").concat(a.scene,"|").concat(a.speechIndex),s=!!(I&&I.get&&I.get(i)))}}catch(e){}if(!s&&eN&&I&&(i=eN,s=!!(I.get&&I.get(i))),!s)try{let t=Y.current,n=e.changedTouches&&e.changedTouches[0],l=(null==n?void 0:n.clientX)||0,o=(null==n?void 0:n.clientY)||0,r=((e,t)=>{var n,l;if(document.caretRangeFromPoint)return document.caretRangeFromPoint(e,t);let o=null===(n=(l=document).caretPositionFromPoint)||void 0===n?void 0:n.call(l,e,t);if(o){let e=document.createRange();return e.setStart(o.offsetNode,o.offset),e.collapse(!0),e}return null})(l,o);if(t&&r){let e=document.createRange();e.selectNodeContents(t);let n=e.cloneRange();n.setEnd(r.startContainer,r.startOffset);let l=n.toString().length,o=new TextEncoder().encode((a||"").slice(0,l)).length,c=(L||0)+o,u=null;for(let e of C||[]){let t=I.get("".concat(e.act,"|").concat(e.scene,"|").concat(e.speechIndex));if(t&&c>=(t.startOffset||0)&&c<=(t.endOffset||t.startOffset||0)){u=e;break}}u&&(i="".concat(u.act,"|").concat(u.scene,"|").concat(u.speechIndex),s=!!(I&&I.get&&I.get(i)))}}catch(e){}if(s&&i){ey.has(i)&&ex(e=>{let t=new Set(e);return t.delete(i),t});let e=eC.has(i);if(B&&B(i,N),e){if(ex(e=>{let t=new Set(e);return t.add(i),t}),F&&F(i),Array.isArray(eX)&&eX.length){let e=new TextEncoder;for(let t of eX){let n=null==t?void 0:t.meta;if(!n)continue;let l=n.speechKey;if(!(l?l===i:n.sectionIndex===N))continue;let o=e.encode(n.text||"").length;null==R||R("".concat(n.byteOffset,"-").concat(o))}}null==m||null===(r=m.onDeleteCurrent)||void 0===r||r.call(m)}else e4()}eh.current=!0,V.current=!1,setTimeout(()=>{z.current=!1},80)},style:{cursor:ee&&en?"text":"pointer",border:en?"1px solid #c9c0b8":"none",borderRadius:en?"2px":"0",backgroundColor:en?"#faf9f7":"transparent",transition:"all 0.2s ease",userSelect:en?"text":void 0,WebkitUserSelect:en?"text":void 0,WebkitTouchCallout:en?"default":void 0,WebkitTapHighlightColor:en?"rgba(0,0,0,0.2)":void 0},children:e9})]}),e_?(0,l.jsxs)("aside",{className:"explanations","aria-label":"Explanations",ref:K,onClick:e=>{var t,n,l,o,r;if(!eD&&eW&&(e.target===K.current||e.target===(null===(t=K.current)||void 0===t?void 0:t.firstChild)&&!(null===(l=K.current.firstChild)||void 0===l?void 0:null===(n=l.textContent)||void 0===n?void 0:n.trim()))||!eD&&!(null==v?void 0:v.length)&&eW&&(null===(o=K.current)||void 0===o?void 0:o.contains(e.target))&&!Array.from((null===(r=K.current)||void 0===r?void 0:r.children)||[]).some(e=>{var t,n;return(null===(t=e.textContent)||void 0===t?void 0:t.trim())&&!(null===(n=e.classList)||void 0===n?void 0:n.contains("placeholder"))})){e.stopPropagation(),e6(),e4();return}},style:{cursor:eW&&!eD?"pointer":"default"},children:[eD?(0,l.jsx)("div",{children:(()=>{if(!eD)return null;let e=eE(eD),t=()=>es(e=>!e),n=async()=>{let e=(ec||"").trim();if(e)try{ef(!0);let t=Math.max(0,(eD.startOffset||0)-L),n=Math.max(t+1,(eD.endOffset||(eD.startOffset||0)+1)-L),l=x(a||"",t),o=x(a||"",n),r=(a||"").slice(l,o),s=y(D||{},eD.startOffset||0),c=await fetch((0,i.k)("/api/explain"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selectionText:r,context:{act:s.act,scene:s.scene,speaker:s.speaker,onStage:s.onStage},options:null==m?void 0:m.options,messages:[],mode:"followup",followup:e})}),u=await c.json();if(!c.ok)throw Error((null==u?void 0:u.detail)||(null==u?void 0:u.error)||"LLM error");let d=(null==u?void 0:u.content)||"",f=String(eD.startOffset||0);em(t=>{var n,l;let o=Array.isArray(t[f])?t[f].slice():[];return o.push({q:e,a:d,model:(null==m?void 0:null===(n=m.options)||void 0===n?void 0:n.model)||"",provider:(null==m?void 0:null===(l=m.options)||void 0===l?void 0:l.provider)||""}),{...t,[f]:o}}),eu("")}catch(n){let t=String(eD.startOffset||0);em(l=>{var o,r;let i=Array.isArray(l[t])?l[t].slice():[];return i.push({q:e,a:"Error: ".concat(String(n.message||n)),model:(null==m?void 0:null===(o=m.options)||void 0===o?void 0:o.model)||"",provider:(null==m?void 0:null===(r=m.options)||void 0===r?void 0:r.provider)||""}),{...l,[t]:i}})}finally{ef(!1)}},o=async()=>{let e=String(eD.startOffset||0),t=(eD.content||"").trim();try{ef(!0);let n=Math.max(0,(eD.startOffset||0)-L),l=Math.max(n+1,(eD.endOffset||(eD.startOffset||0)+1)-L),o=x(a||"",n),r=x(a||"",l),s=(a||"").slice(o,r),c=y(D||{},eD.startOffset||0),u=await fetch((0,i.k)("/api/explain"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selectionText:s,context:{act:c.act,scene:c.scene,speaker:c.speaker,onStage:c.onStage},options:null==m?void 0:m.options,messages:[],mode:"followup",followup:t?'Provide additional insight that builds on the existing explanation below without repeating or paraphrasing it. Focus on new details, clarifying tricky references, or subtle dramatic function.\nExisting explanation:\n"""'.concat(t,'"""'):"Please expand this into a longer explanation with more detail while avoiding repetition."})}),d=await u.json();if(!u.ok)throw Error((null==d?void 0:d.detail)||(null==d?void 0:d.error)||"LLM error");let f=((null==d?void 0:d.content)||"").trim();em(t=>{var n,l;let o=Array.isArray(t[e])?t[e].slice():[];return o.push({q:"More detail",a:f,model:(null==m?void 0:null===(n=m.options)||void 0===n?void 0:n.model)||"",provider:(null==m?void 0:null===(l=m.options)||void 0===l?void 0:l.provider)||""}),{...t,[e]:o}})}catch(t){em(n=>{var l,o;let r=Array.isArray(n[e])?n[e].slice():[];return r.push({q:"More detail",a:"Error: ".concat(String(t.message||t)),model:(null==m?void 0:null===(l=m.options)||void 0===l?void 0:l.model)||"",provider:(null==m?void 0:null===(o=m.options)||void 0===o?void 0:o.provider)||""}),{...n,[e]:r}})}finally{ef(!1)}};return(0,l.jsxs)("div",{style:{paddingRight:"32px",paddingTop:"6px",borderBottom:"1px solid #eee",position:"relative"},children:[(0,l.jsx)("button",{type:"button",className:"closeBtn",onClick:t=>{var n,l,o,r;if(t.stopPropagation(),t.preventDefault(),!e)return;if(eC.has(String(e))&&B&&B(e,N),ex(t=>{let n=new Set(t);return n.add(e),n}),eg(!1),F&&F(e),Array.isArray(eX)&&eX.length){let t=new TextEncoder;for(let n of eX){let l=null==n?void 0:n.meta;if(!l)continue;let o=l.speechKey;if(!(o?o===e:l.sectionIndex===N))continue;let r=t.encode(l.text||"").length;null==R||R("".concat(l.byteOffset,"-").concat(r))}}null==m||null===(n=m.onDeleteCurrent)||void 0===n||n.call(m),null==f||f(null),"function"==typeof P?P():P&&"object"==typeof P&&(P.current=!0),J&&J(null),es(!1),eu(""),ef(!1);let i=String(eD.startOffset||0);em(e=>{if(!e||!Object.prototype.hasOwnProperty.call(e,i))return e;let t={...e};return delete t[i],t});try{{let e=null===(l=(o=window).getSelection)||void 0===l?void 0:l.call(o);null==e||null===(r=e.removeAllRanges)||void 0===r||r.call(e)}}catch(e){}},"aria-label":"Close note",style:{position:"absolute",right:0,top:0},children:"✕"}),(0,l.jsx)("div",{className:"noteContent",style:{whiteSpace:"pre-wrap",cursor:"pointer",userSelect:"text"},onClick:n=>{var l,o,r,i,a;n.stopPropagation(),n.preventDefault();let s=!!d,c=!!(d&&p&&(null==m?void 0:null===(l=m.conversation)||void 0===l?void 0:l.last)&&(null==m?void 0:null===(o=m.conversation)||void 0===o?void 0:o.last)!=="AI is thinking…"),u=W===e;if(ea||u||s||c){null==f||f(null),"function"==typeof P?P():P&&"object"==typeof P&&(P.current=!0),J&&J(null),es(!1),eu(""),ef(!1);try{{let e=null===(r=(i=window).getSelection)||void 0===r?void 0:r.call(i);null==e||null===(a=e.removeAllRanges)||void 0===a||a.call(e)}}catch(e){}return}if(J&&e){P&&"object"==typeof P&&(P.current=!1),J(e);return}t()},title:W===e?"Click to exit text selection mode":"Click to enable text selection mode",children:eD.content||""}),(0,l.jsx)("div",{style:{fontStyle:"italic",fontSize:"0.85em",color:"#6b5f53",marginTop:4},children:(()=>{var e;if(eD.provider||eD.model){let e=eD.provider||"",t=eD.model||"",n=h(e);if(e&&t)return t.toLowerCase().includes(e.toLowerCase())?n||t:n?"".concat(t," (via ").concat(n,")"):t;if(t)return"Model: ".concat(t);if(n)return n}return(null==m?void 0:null===(e=m.options)||void 0===e?void 0:e.model)?"Model: ".concat(m.options.model):""})()}),ea&&(0,l.jsx)(l.Fragment,{children:(0,l.jsxs)("div",{style:{marginTop:"0.5rem",display:"flex",gap:"0.5rem",alignItems:"center",flexWrap:"wrap"},children:[(0,l.jsx)("input",{type:"text",placeholder:"Ask a follow‑up…",value:ec,onChange:e=>{e.stopPropagation(),eu(e.target.value)},onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),n())},style:{flex:1,minWidth:0}}),(0,l.jsx)("button",{type:"button",disabled:ed||!ec.trim(),onClick:e=>{e.stopPropagation(),n()},children:"Ask"}),(0,l.jsx)("button",{type:"button",disabled:ed,onClick:e=>{e.stopPropagation(),o()},title:"Get a longer response",children:"More"})]})}),ed&&(0,l.jsx)("div",{style:{marginTop:"0.5rem",color:"#6b5f53"},children:"Thinking…"}),(()=>{let e=ep[String(eD.startOffset||0)]||[];return e.length?(0,l.jsx)("div",{style:{marginTop:"0.5rem"},children:e.map((e,t)=>{var n,o,r,i,a;let s=h((null==e?void 0:e.provider)||""),c="";if((null==e?void 0:e.model)&&s?c="".concat(e.model," (via ").concat(s,")"):(null==e?void 0:e.model)?c="Model: ".concat(e.model):s&&(c=s),!c&&((null==m?void 0:null===(n=m.options)||void 0===n?void 0:n.model)||(null==m?void 0:null===(o=m.options)||void 0===o?void 0:o.provider))){let e=h((null==m?void 0:null===(r=m.options)||void 0===r?void 0:r.provider)||""),t=(null==m?void 0:null===(i=m.options)||void 0===i?void 0:i.model)||"";t&&e&&t.toLowerCase().includes(((null==m?void 0:null===(a=m.options)||void 0===a?void 0:a.provider)||"").toLowerCase())?c=t:t&&e?c="".concat(t," (via ").concat(e,")"):t?c="Model: ".concat(t):e&&(c=e)}return(0,l.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,l.jsx)("div",{style:{whiteSpace:"pre-wrap"},children:e.a}),c?(0,l.jsx)("div",{style:{fontStyle:"italic",fontSize:"0.85em",color:"#6b5f53",marginTop:2},children:c}):null]},"fu-".concat(t))})}):null})()]},"pc-".concat(er,"-").concat(eD.startOffset||er))})()}):null,e5,e2,e3,e8]}):null]})}function g(e,t,n){if(!t||!t.trim())return e;let o=t.trim();try{let t;let r=RegExp(o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),i=[],a=0,s=0;for(;null!==(t=r.exec(e));){let{index:o}=t;o>a&&i.push(e.slice(a,o));let r=t[0];i.push((0,l.jsx)("span",{className:"highlight",ref:e=>{e&&n.current.push(e)},children:r},"m-".concat(s++))),a=o+r.length}return a<e.length&&i.push(e.slice(a)),i}catch(t){return e}}function y(e,t){var n,l;if(!e)return{act:null,scene:null,onStage:[],speaker:null};let o=null,r=null;for(let n of e.scenes||[])if(null!=n.startOffset&&null!=n.endOffset&&t>=n.startOffset&&t<=n.endOffset){o=n.act,r=n.scene;break}let i=[];for(let l=((null===(n=e.stageEvents)||void 0===n?void 0:n.length)||0)-1;l>=0;l--){let n=e.stageEvents[l];if(n.offset<=t){i=n.onStage||[];break}}let a=null;for(let n=((null===(l=e.speeches)||void 0===l?void 0:l.length)||0)-1;n>=0;n--){let l=e.speeches[n];if(l.offset<=t){a=l.speaker;break}}return{act:o,scene:r,onStage:i,speaker:a}}function x(e,t){let n=new TextEncoder,l=0;for(let o=0;o<e.length;o++){let r=n.encode(e[o]).length;if(l+r>t)return o;l+=r}return e.length}function w(e,t){let n=new URL(window.location.href);return n.hash="sel=".concat(e,"-").concat(t),n.toString()}function b(e,t){if(!e||t<0||t>e.length)return null;let n=e.length,l=t,o=t,r=!1;for(let n=t-1;n>=0;n--){let t=e[n];if("."===t||"!"===t||"?"===t||";"===t){l=n+1,r=!0;break}}for(r||(l=0);l<n&&(" "===e[l]||"	"===e[l]||"\n"===e[l]||"\r"===e[l]);)l++;let i=!1;for(let l=t;l<n;l++){let t=e[l];if("."===t||"!"===t||"?"===t||";"===t){for(o=l+1;o<n;){let t=e[o];if('"'===t||"'"===t||")"===t||"]"===t)o++;else break}i=!0;break}}for(i||(o=n);o>l;){let t=e[o-1];if(" "===t||"	"===t||"\n"===t||"\r"===t)o--;else break}return o>l?{start:l,end:o}:null}function S(e){let{contextInfo:t,llm:n,onRequestFocus:o,noteMode:i=!1,onNoteMore:a,onNoteFollowup:s}=e,{loading:c,onFollowup:u,conversation:d}=n||{},[f,h]=(0,r.useState)(""),p=()=>{let e=(f||"").trim();e&&(i&&s?s(e):null==u||u(e),h(""))},m=c&&(null==d?void 0:d.last)&&"AI is thinking…"!==d.last,v=!!t,g=!v&&!i,y=v||i;return(0,l.jsxs)("div",{style:{marginTop:i?"0.25rem":"0.5rem",display:"flex",gap:"0.5rem",alignItems:"center",flexWrap:"wrap"},children:[y?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("input",{type:"text",placeholder:"Ask a follow‑up…",value:f,onChange:e=>h(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),p())},style:{flex:1,minWidth:0}}),(0,l.jsx)("button",{type:"button",disabled:c||!f.trim(),onClick:p,children:"Ask"})]}):g?(0,l.jsx)("div",{style:{flex:1,fontSize:"0.9em",color:"#6b5f53",fontStyle:"italic"},children:"Tap a sentence or drag to select text"}):(0,l.jsx)("div",{style:{flex:1}}),(0,l.jsx)("button",{type:"button",disabled:c||!v&&!i,onClick:()=>{i&&a?a():null==u||u("Expand into a longer, more detailed explanation without repeating earlier sentences.")},children:"More"}),m&&(0,l.jsx)("span",{style:{color:"#6b5f53"},children:"Thinking…"})]})}function O(e){let{passage:t,content:n,onLocate:o,onCopy:a,onDelete:s,meta:c,options:u}=e,[d,f]=(0,r.useState)(!1),[h,p]=(0,r.useState)(""),[m,v]=(0,r.useState)(!1),[g,y]=(0,r.useState)([]),x=async e=>{let n=(e||h||"").trim();if(n)try{v(!0);let e=await fetch((0,i.k)("/api/explain"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selectionText:(null==c?void 0:c.text)||t||"",context:{act:null==c?void 0:c.act,scene:null==c?void 0:c.scene,speaker:null==c?void 0:c.speaker,onStage:null==c?void 0:c.onStage},options:u||{},messages:[],mode:"followup",followup:n})}),l=await e.json();if(!e.ok)throw Error((null==l?void 0:l.detail)||(null==l?void 0:l.error)||"LLM error");y(e=>e.concat({q:n,a:(null==l?void 0:l.content)||""})),p("")}catch(e){y(t=>t.concat({q:n,a:"Error: ".concat(String(e.message||e))}))}finally{v(!1)}};return(0,l.jsxs)("div",{style:{marginTop:"0.5rem",paddingTop:"0.5rem",paddingRight:"32px",borderTop:"1px solid #eee",position:"relative"},children:[(0,l.jsx)("button",{type:"button",className:"closeBtn",onClick:s,"aria-label":"Delete saved explanation",style:{position:"absolute",right:0,top:0,width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",padding:0},children:"\uD83D\uDDD1️"}),(()=>{let e=(t||"").trim();return e?(0,l.jsx)("div",{style:{marginBottom:"0.5rem",paddingLeft:"1rem",borderLeft:"3px solid #e8d8b5",fontStyle:"italic",color:"#4a4036",whiteSpace:"pre-wrap"},children:e}):null})(),(0,l.jsxs)("div",{style:{marginTop:"0.25rem"},onClick:()=>{null==o||o(),f(e=>!e)},title:"Click to highlight source and toggle follow‑up",children:[(0,l.jsx)("div",{style:{fontWeight:600,marginBottom:"0.25rem"},children:"Saved Explanation"}),(0,l.jsx)("div",{style:{whiteSpace:"pre-wrap",cursor:"pointer"},children:n||"—"}),(0,l.jsx)("div",{style:{fontStyle:"italic",fontSize:"0.85em",color:"#6b5f53",marginTop:4},children:(null==u?void 0:u.model)?"Model: ".concat(u.model):""})]}),d&&(0,l.jsxs)("div",{style:{marginTop:"0.5rem",display:"flex",gap:"0.5rem",alignItems:"center",flexWrap:"wrap"},children:[(0,l.jsx)("input",{type:"text",placeholder:"Ask a follow‑up…",value:h,onChange:e=>p(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),x())},style:{flex:1,minWidth:0}}),(0,l.jsx)("button",{type:"button",disabled:m||!h.trim(),onClick:()=>x(),children:"Ask"}),(0,l.jsx)("button",{type:"button",disabled:m,onClick:()=>x("Expand into a longer, more detailed explanation without repeating earlier sentences."),children:"More"}),m&&(0,l.jsx)("span",{style:{color:"#6b5f53"},children:"Thinking…"})]}),d&&g.length>0&&(0,l.jsx)("div",{style:{marginTop:"0.5rem"},children:g.map((e,t)=>(0,l.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,l.jsx)("div",{style:{whiteSpace:"pre-wrap"},children:e.a}),(0,l.jsx)("div",{style:{fontStyle:"italic",fontSize:"0.85em",color:"#6b5f53",marginTop:2},children:(null==u?void 0:u.model)?"Model: ".concat(u.model):""})]},"fu-".concat(t)))})]})}}},function(e){e.O(0,[888,774,179],function(){return e(e.s=5557)}),_N_E=e.O()}]);